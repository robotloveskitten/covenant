<div class="min-h-screen" data-controller="view-toggle">
  <!-- Header -->
  <header class="border-b border-base-200 bg-base-100 sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-6 py-3">
      <!-- Breadcrumb -->
      <%= render partial: 'breadcrumb', locals: { task: @task } %>
      
      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center gap-3">
          <span class="badge badge-soft badge-sm <%= task_type_color(@task.task_type) %>"><%= @task.task_type.capitalize %></span>
          <h1 class="text-2xl font-semibold text-base-content"><%= @task.title %></h1>
        </div>
        
        <div class="flex items-center gap-2">
          <!-- View toggle -->
          <div class="join">
            <button class="join-item btn btn-sm" 
                    data-view-toggle-target="documentBtn"
                    data-action="click->view-toggle#showDocument"
                    data-active-class="btn-active">
              Document
            </button>
            <button class="join-item btn btn-sm"
                    data-view-toggle-target="kanbanBtn"
                    data-action="click->view-toggle#showKanban">
              Kanban
            </button>
          </div>
          
          <% if user_signed_in? %>
            <%= link_to edit_task_path(@task), class: "btn btn-sm btn-ghost" do %>
              Edit
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </header>

  <!-- Document View -->
  <div data-view-toggle-target="documentView">
    <main class="max-w-6xl mx-auto px-6 py-6">
      <div class="flex gap-8">
        <!-- Main content area (2/3) -->
        <div class="flex-1 min-w-0">
          <!-- Task metadata -->
          <div class="flex flex-col flex-wrap gap-2 mb-6 text-sm" data-controller="task-field" data-task-field-url-value="<%= task_path(@task) %>">
            <div class="flex items-center gap-2">
              <span class="text-base-content/50">Status</span>
              <span class="badge badge-sm badge-soft <%= status_badge_class(@task.status) %>"><%= @task.status_label %></span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-base-content/50">Assignee</span>
              <% if user_signed_in? %>
                <%= render partial: 'assignee_combobox', locals: { task: @task } %>
              <% elsif @task.assignee %>
                <span class="text-base-content"><%= @task.assignee.display_name %></span>
              <% else %>
                <span class="text-base-content/40">Unassigned</span>
              <% end %>
            </div>
            <%# Due date %>
            <div class="flex items-center gap-2">
              <% if @task.due_date %>
                <div class="flex items-center gap-2">
                  <span class="text-base-content/50">Due</span>
                  <span class="text-base-content"><%= @task.due_date.strftime("%B %d, %Y") %></span>
                </div>
              <% end %>
            </div>
            <%# Tags %>
            <div class="flex items-center gap-2">
              <span class="text-base-content/50">Tags</span>
              <% if user_signed_in? %>
                <%= render partial: 'tag_combobox', locals: { task: @task } %>
              <% elsif @task.tags.any? %>
                <% @task.tags.each do |tag| %>
                  <span class="badge badge-sm" style="background-color: <%= tag.color %>20; color: <%= tag.color %>"><%= tag.name %></span>
                <% end %>
              <% else %>
                <span class="text-base-content/40">No tags</span>
              <% end %>
            </div>
          </div>

          <!-- Content -->
          <div class="overflow-hidden" data-controller="tiptap" data-tiptap-editable-value="<%= user_signed_in? %>" data-tiptap-task-id-value="<%= @task.id %>">
            <% if user_signed_in? %>
              <!-- Bubble Menu (floating toolbar on text selection) -->
              <div data-tiptap-target="bubbleMenu" class="bubble-menu">
                <div class="flex items-center gap-0.5 p-1 bg-base-100 border border-base-200 rounded-lg shadow-lg">
                  <button type="button" class="btn btn-xs btn-ghost font-bold" data-action="click->tiptap#toggleBold" title="Bold">B</button>
                  <button type="button" class="btn btn-xs btn-ghost italic" data-action="click->tiptap#toggleItalic" title="Italic">I</button>
                  <button type="button" class="btn btn-xs btn-ghost underline" data-action="click->tiptap#toggleUnderline" title="Underline">U</button>
                  <button type="button" class="btn btn-xs btn-ghost line-through" data-action="click->tiptap#toggleStrike" title="Strikethrough">S</button>
                  <div class="divider divider-horizontal mx-0.5 h-4"></div>
                  <button type="button" class="btn btn-xs btn-ghost" data-action="click->tiptap#setLink" title="Add link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                  </button>
                  <button type="button" class="btn btn-xs btn-ghost" data-action="click->tiptap#toggleHighlight" data-color="#fef08a" title="Highlight">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 11-6 6v3h9l3-3"/><path d="m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/></svg>
                  </button>
                </div>
              </div>
            <% end %>
            <div data-tiptap-target="editor" class="prose prose-sm max-w-none min-h-[200px] focus:outline-none">
              <% if @task.content.present? %>
                <%= raw @task.content %>
              <% else %>
                <p class="text-base-content/40">Click to add content...</p>
              <% end %>
            </div>
          </div>

          <!-- Children list -->
          <% if @children.any? %>
            <div class="mt-8 pt-8 border-t border-base-200">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-base-content/70">Sub-items</h3>
                <% if user_signed_in? && @task.allowed_child_types.any? %>
                  <%= link_to new_task_path(parent_id: @task.id, task_type: @task.allowed_child_types.first), class: "btn btn-xs btn-ghost" do %>
                    + Add
                  <% end %>
                <% end %>
              </div>
              <div class="space-y-1">
                <% @children.each do |child| %>
                  <%= render partial: 'task_list_item', locals: { task: child } %>
                <% end %>
              </div>
            </div>
          <% elsif user_signed_in? && @task.allowed_child_types.any? %>
            <div class="mt-8 pt-8 border-t border-base-200">
              <%= link_to new_task_path(parent_id: @task.id, task_type: @task.allowed_child_types.first), class: "text-sm text-base-content/40 hover:text-base-content" do %>
                + Add sub-item
              <% end %>
            </div>
          <% end %>
        </div>

        <!-- Sidebar (1/3) -->
        <%= render partial: 'sidebar', locals: { task: @task } %>
      </div>
    </main>
  </div>

  <!-- Kanban View -->
  <div data-view-toggle-target="kanbanView" class="hidden">
    <main class="max-w-6xl mx-auto px-6 py-6">
      <%= render partial: 'kanban_board', locals: { task: @task, children: @children } %>
    </main>
  </div>
</div>
